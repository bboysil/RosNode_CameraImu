<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Demo - The Web's Sixth Sense: A Study of Scripts Accessing Smartphone Sensors</title>
    <link href="/assets/css/bootstrap.min.css" rel="stylesheet">
    <title>JavaScript Sensor Access Demo</title>
    <style>
      #demo-div {color: lightgrey; border-radius: 0.3rem;}
      #demo-div span, #demo-div #num-observed-events {color: black;}
      h1 {margin-top: 0.5rem;}
      h4 {margin-top: 0.66rem; font-size:1.33rem;}
      #demo-div li {line-height: 21px;}
      #demo-div ul {margin-bottom: 0.66rem;}
    </style>
    <script src="http://static.robotwebtools.org/EventEmitter2/current/eventemitter2.min.js"></script>
    <script src="http://static.robotwebtools.org/roslibjs/current/roslib.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.min.js"></script>    
</head>
<body>
<main role="main" class="container">
  <!-- declare interface and the canvases that will display the video and the still shots -->
  <video style="display: inline" autoplay muted playsinline id="video"></video>
  <canvas style="display: inline" id="canvas"></canvas>
<!--
<h1 align="left">JavaScript ROS Node publishing Camera and IMU sensors</h1>
<p><b>Run from mobile phone or tablet device.</b></p>
<p>This page access sensor data from mobile devices using <a href="https://developer.mozilla.org/en-US/docs/Web/Events/deviceorientation"><i>deviceorientation</i></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/Events/devicemotion"><i>devicemotion</i></a> events.</p>

<p><i>deviceorientation</i> provides <i>alpha</i>, <i>beta</i> and <i>gamma</i> components which correspond to orientation along the Z, X and Y axes, respectively.</p><p><i>devicemotion</i> provides acceleration and rotation rate along three axes using MEMS accelerometers and gyroscopes.</p>
  -->
<div class="p-3 mb-2 bg-secondary" id="demo-div">

<a id="start_demo" class="btn btn-lg btn-success py-1" href="#" role="button">Start</a>
<p style="margin-top:1rem;">Num. of datapoints: <span class="badge badge-warning" id="num-observed-events">0</span></p>


<h4 style="margin-top:0.75rem;">Orientation</h4>
<ul>
  <li>X-axis (&beta;): <span id="Orientation_b">0</span><span>&deg;</span></li>
  <li>Y-axis (&gamma;): <span id="Orientation_g">0</span><span>&deg;</span></li>
  <li>Z-axis (&alpha;): <span id="Orientation_a">0</span><span>&deg;</span></li>
</ul>

<h4>Accelerometer</h4>
<ul>
  <li>X-axis: <span id="Accelerometer_x">0</span><span> m/s<sup>2</sup></span></li>
  <li>Y-axis: <span id="Accelerometer_y">0</span><span> m/s<sup>2</sup></span></li>
  <li>Z-axis: <span id="Accelerometer_z">0</span><span> m/s<sup>2</sup></span></li>
  <li>Data Interval: <span id="Accelerometer_i">0</span><span> ms</span></li>
</ul>

<h4>Accelerometer including gravity</h4>

<ul>
  <li>X-axis: <span id="Accelerometer_gx">0</span><span> m/s<sup>2</sup></span></li>
  <li>Y-axis: <span id="Accelerometer_gy">0</span><span> m/s<sup>2</sup></span></li>
  <li>Z-axis: <span id="Accelerometer_gz">0</span><span> m/s<sup>2</sup></span></li>
</ul>

<h4>Gyroscope</h4>
<ul>
  <li>X-axis: <span id="Gyroscope_x">0</span><span>&deg;/s</span></li>
  <li>Y-axis: <span id="Gyroscope_y">0</span><span>&deg;/s</span></li>
  <li>Z-axis: <span id="Gyroscope_z">0</span><span>&deg;/s</span></li>
</ul>

</div>
</main>
<footer class="footer">
  <div class="container">
    <span class="text-muted small">Experimental. v0.0.2</span>
  </div>
</footer>
<script>

function handleOrientation(event) {
  updateFieldIfNotNull('Orientation_a', event.alpha);
  updateFieldIfNotNull('Orientation_b', event.beta);
  updateFieldIfNotNull('Orientation_g', event.gamma);
  incrementEventCount();
}

function incrementEventCount(){
  let counterElement = document.getElementById("num-observed-events")
  let eventCount = parseInt(counterElement.innerHTML)
  counterElement.innerHTML = eventCount + 1;
}

function updateFieldIfNotNull(fieldName, value, precision=10){
  if (value != null)
    document.getElementById(fieldName).innerHTML = value.toFixed(precision);
}

var latesMotionEvent;

function handleMotion(event) {
  //updateFieldIfNotNull('Accelerometer_gx', event.accelerationIncludingGravity.x);
  //updateFieldIfNotNull('Accelerometer_gy', event.accelerationIncludingGravity.y);
  //updateFieldIfNotNull('Accelerometer_gz', event.accelerationIncludingGravity.z);
//
  //updateFieldIfNotNull('Accelerometer_x', event.acceleration.x);
  //updateFieldIfNotNull('Accelerometer_y', event.acceleration.y);
  //updateFieldIfNotNull('Accelerometer_z', event.acceleration.z);
//
  updateFieldIfNotNull('Accelerometer_i', event.interval, 2);
//
  //updateFieldIfNotNull('Gyroscope_z', event.rotationRate.alpha);
  //updateFieldIfNotNull('Gyroscope_x', event.rotationRate.beta);
  //updateFieldIfNotNull('Gyroscope_y', event.rotationRate.gamma);
  incrementEventCount();
  latesMotionEvent = event;
  imusnapshot(latesMotionEvent);
}

let is_running = false;
let demo_button = document.getElementById("start_demo");
demo_button.onclick = function(e) {
  e.preventDefault();
  
  // Request permission for iOS 13+ devices
  if (
    typeof DeviceMotionEvent != 'undefined' &&
    typeof DeviceMotionEvent.requestPermission === "function"
  ) {
    DeviceMotionEvent.requestPermission();
  }
  
  if (is_running) {
    window.removeEventListener("devicemotion", handleMotion);
    window.removeEventListener("deviceorientation", handleOrientation);
    demo_button.innerHTML = "Start";
    demo_button.classList.add('btn-success');
    demo_button.classList.remove('btn-danger');
    is_running = false;
    stopCamera();
    ros.close();
  } else {
    //ros.connect("ws://" + window.location.hostname + ":9090");
    ros.connect("ws://192.168.1.10:9090");   

    window.addEventListener("devicemotion", handleMotion);
    window.addEventListener("deviceorientation", handleOrientation);
    document.getElementById("start_demo").innerHTML = "Stop";
    demo_button.classList.remove('btn-success');
    demo_button.classList.add('btn-danger');
    is_running = true;
    startCamera();
  }
};

      function startCamera() {
          cameraOn();
          cameraTimer = setInterval(function () {
            takepicture();
            //window.alert("Picture");
          }, 65);       // publish images at 15 fps
          imuTimer = setInterval(function () {
            //imusnapshot(latesMotionEvent);
          }, 4);       // publish an IMU message at 200 hz
        }

        function stopCamera() {
          cameraOff();
          clearInterval(cameraTimer);
          clearInterval(imuTimer);
          cameraTimer = null;
          imuTimer = null;
        }

// setup connection to the ROS server and prepare the topic
var ros = new ROSLIB.Ros();

ros.on('connection', function() { console.log('Connected to websocket server.');});

ros.on('error', function(error) { console.log('Error connecting to websocket server: ', error); window.alert('Error connecting to websocket server'); });

ros.on('close', function() { console.log('Connection to websocket server closed.');});

var imageTopic = new ROSLIB.Topic({
  ros : ros,
  name : '/camera/image/compressed',
  messageType : 'sensor_msgs/CompressedImage'
});

var imuTopic = new ROSLIB.Topic({
  ros : ros,
  name : '/gyro',
  messageType : 'sensor_msgs/Imu'
});

var cameraTimer, imuTimer;
  
function cameraOn() {
  async function getMedia(constraints) {
    let stream = null;

    try {
      navigator.mediaDevices.getUserMedia(constraints)
        .then(function (mediaStream) {
          var video = document.querySelector('#video');
          video.srcObject = mediaStream;
          video.onloadedmetadata = function (e) {
            video.play();
          };
        })
        .catch(function (err) { console.log(err.name + ": " + err.message); }); // always check for errors at the end.
      /* use the stream */
    } catch (err) {
      /* handle the error */
    }
  }

  const constraints = {
    audio: false,
    video: {
      width: { min: 640, ideal: 1280, max: 1920 },
      height: { min: 480, ideal: 720, max: 1080 },
      facingMode: { ideal: 'environment' },
    }
  };

  getMedia(constraints);
}


function cameraOff() {
      hasRunOnce = false;
      video.srcObject.getTracks().forEach(function(track) {
        track.stop();
      });
      video.srcObject = null;
      takepicture();                  // blank the screen to prevent last image from staying
  }

  var hasRunOnce = false,
    video        = document.querySelector('#video'),
    canvas       = document.querySelector('#canvas'),
    width = 1280,
    height;           // calculated once video stream size is known

// function that is run once scale the height of the video stream to match the configured target width
video.addEventListener('canplay', function(ev){
  if (!hasRunOnce) {
    ratio = video.videoHeight / (video.videoWidth);
    height = width * ratio; // height is set up right above this function
    video.setAttribute('width', width/10);
    video.setAttribute('height', height/10);
    canvas.setAttribute('width', width);
    canvas.setAttribute('height', height);
    hasRunOnce = true;
  }
}, false);

// function that is run by trigger several times a second
// takes snapshot of video to canvas, encodes the images as base 64 and sends it to the ROS topic
function takepicture() {
  canvas.width = width;
  canvas.height = height;
  console.log('takepicture');
  canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);   

  var data = canvas.toDataURL('image/jpeg');
  var imageMessage = new ROSLIB.Message({
      header : {
           frame_id : "cam0"
        },
      format : "jpeg",
      data : data.replace("data:image/jpeg;base64,", "")
  });

  imageTopic.publish(imageMessage);
}

 function imusnapshot(event) {
     var x = event.accelerationIncludingGravity.x
     var y = event.accelerationIncludingGravity.y
     var z = event.accelerationIncludingGravity.z

    //event.acceleration.x
     //event.acceleration.y
     //event.acceleration.z

     var alpha = event.rotationRate.alpha
     var beta = event.rotationRate.beta
     var gamma = event.rotationRate.gamma

     var beta_radian = ((beta + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
     var gamma_radian = ((gamma + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
     var alpha_radian = ((alpha + 360) / 360 * 2 * Math.PI) % (2 * Math.PI);
     var eurlerpose = new THREE.Euler(beta_radian, gamma_radian, alpha_radian);
     var quaternionpose = new THREE.Quaternion;
     quaternionpose.setFromEuler(eurlerpose);  var imuMessage = new ROSLIB.Message({
        header : {
           frame_id : "imu0"
        },
        orientation : {
           x : 0,//quaternionpose.x,
           y : 0,//quaternionpose.y,
           z : 0,//quaternionpose.z,
           w : 1//quaternionpose.w
        },
        orientation_covariance : [99999.9, 0.0, 0.0, 0.0, 99999.9, 0.0, 0.0, 0.0, 99999.9],
        angular_velocity : {
            x : alpha / 360  * Math.PI ,
            y : -beta / 360  * Math.PI ,
            z : -gamma / 360  * Math.PI ,
        },
        angular_velocity_covariance  : [0,0,0,0,0,0,0,0,0],
        linear_acceleration : {
           x : -x,
           y : y,
           z : -z,
        },
        linear_acceleration_covariance  : [0,0,0,0,0,0,0,0,0],
     });

     imuTopic.publish(imuMessage);
  }

</script>
</body>
</html>